<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title>Подарки</title>
    <meta name="viewport" content="width=device-width">
    <link href="/fonts/all.css" rel="stylesheet">
    <style>* { font-family: 'PT Sans' !important; }</style>
    <link rel="stylesheet" href="/css/bootstrap.css">
    <link rel="stylesheet" href="/css/syntax.css">
    <link rel="stylesheet" href="/css/blog.css">
  </head>
  <body>
    <div class="container">
      <div class="site">
        <div class="header">
  <h1 class="title"><a href="/">Blog</a></h1>
</div>
<h1>Подарки</h1>
<p class="meta">25 Apr 2012</p>

<div class="post">
<p><img src="/assets/6-perfo/perf.jpg" alt=""></p>

<p>Сенека в письмах Луцилию в каждое письмо старался вставить цитату древних мыслителей, он называл это подарком.
К сожалению цитаты древних программистов выглядят так, как на рисунке справа и я не могу воспользоваться этим же способом.
Вместо этого в каждую запись я стараюсь включить код или случай из своей практики.</p>

<p>Сегодня обилие информации в открытом доступе
потенциально позволяет любому специалисту создать проект любого уровня, тайных знаний практически нет. Самым дефицитным
ресурсом является личное время. И если вы потратите целый день на поиск какой-нибудь ошибки, то выпуск проекта мечты также отложится
на этот самый день. Но чем больше случаев из практики вы знаете, тем больше вероятность, что в повседневной деятельности вы распознаете
ошибку или особенность и сэкономите драгоценное время. Сегодняшний пост я хочу посвятить различным мелочам, которые у меня накопились и
может быть что-то вам тоже пригодиться.</p>

<h2>Упасть на первом сломанном спеке</h2>

<p>Когда я мечтал пропатчить <code>test/unit</code>, чтобы он падал на первом сломанном тесте. Так как скучно смотреть
на множество ошибок, которые часто вызваны одной причиной. В <code>rSpec</code> такая возможность есть в
стандартной поставке, ничего патчить не нужно:</p>
<div class="highlight"><pre><code class="text language-text" data-lang="text">rspec --fail-fast
rspec --fail-fast -b # -b(--backtrace) - еще и вывести полный трейс ошибки
</code></pre></div>
<h2>Блоки текста с красивыми отступами</h2>
<div class="highlight"><pre><code class="ruby language-ruby" data-lang="ruby">  <span class="k">class</span> <span class="nc">A</span>
    <span class="k">def</span> <span class="nf">do_some</span>
      <span class="n">cmd</span> <span class="o">=</span> <span class="o">&lt;&lt;-</span><span class="no">CMD</span>
<span class="sh">rake db:migrate</span>
<span class="sh">rake db:test:prepare</span>
<span class="no">CMD</span>
      <span class="nb">system</span> <span class="n">cmd</span>
    <span class="k">end</span>
  <span class="k">end</span>
</code></pre></div>
<p>Раньше я делал примерно так, когда мне нужно было вставить большие куски текста. Коллега подсказал метод <a href="http://api.rubyonrails.org/classes/String.html#method-i-strip_heredoc">strip_heredoc</a> из рейлс, который позволяет вернуть коду необходимую красоту:</p>
<div class="highlight"><pre><code class="ruby language-ruby" data-lang="ruby">  <span class="k">class</span> <span class="nc">A</span>
    <span class="k">def</span> <span class="nf">do_some</span>
      <span class="n">cmd</span> <span class="o">=</span> <span class="o">&lt;&lt;-</span><span class="no">CMD</span><span class="o">.</span><span class="n">strip_heredoc</span>
<span class="sh">        rake db:migrate</span>
<span class="sh">        rake db:test:prepare</span>
<span class="no">      CMD</span>
      <span class="nb">system</span> <span class="n">cmd</span>
    <span class="k">end</span>
  <span class="k">end</span>
</code></pre></div>
<h2>Фильтры в контроллерах запускаются в области видимости контроллера</h2>

<p>Мне кажется, что я где-то прочитал, что блочные фильтры в контроллере нужно писать так:</p>
<div class="highlight"><pre><code class="ruby language-ruby" data-lang="ruby"><span class="k">class</span> <span class="nc">HomeController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="n">before_filter</span> <span class="k">do</span> <span class="o">|</span><span class="n">controller</span><span class="o">|</span>
    <span class="k">raise</span> <span class="s2">&quot;Access Denied&quot;</span> <span class="k">if</span> <span class="n">controller</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">port</span> <span class="o">==</span> <span class="mi">3000</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div>
<p>Но оказывается параметр <code>controller</code> не нужен. Из-за особенностей реализации фильтров через AS-колбеки <a href="https://github.com/rails/rails/blob/master/activesupport/lib/active_support/callbacks.rb#L337">activesupport/lib/active_support/callbacks.rb#L337</a> код вызывается как обычный
метод, поэтому можно написать так:</p>
<div class="highlight"><pre><code class="ruby language-ruby" data-lang="ruby"><span class="k">class</span> <span class="nc">HomeController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="n">before_filter</span> <span class="k">do</span>
    <span class="k">raise</span> <span class="s2">&quot;Access Denied&quot;</span> <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">port</span> <span class="o">==</span> <span class="mi">3000</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div>
<h2>Параметр size в image_tag</h2>
<div class="highlight"><pre><code class="ruby language-ruby" data-lang="ruby"><span class="n">image_tag</span><span class="p">(</span><span class="s1">&#39;image.jpg&#39;</span><span class="p">,</span> <span class="ss">size</span><span class="p">:</span> <span class="s1">&#39;70x25&#39;</span><span class="p">)</span>
    <span class="c1"># =&gt; &lt;img alt=&quot;Image&quot; height=&quot;25&quot; src=&quot;/assets/image.jpg&quot; width=&quot;70&quot; /&gt;</span>
</code></pre></div>
<p>Это штришок тоже почему-то ускользнул от меня, я долгое время использовал явные <code>:width</code> и <code>:height</code> (кстати вы всегда 
&#39;ширина&#39; и &#39;высота&#39; пишете правильно с первой попытки? :-))</p>

<h2>Использование хэлпер методов вне контроллера</h2>

<p>Не всегда удается развести всю логику строго по MVC, поэтому всегда можно подхачить, например вот так:</p>
<div class="highlight"><pre><code class="ruby language-ruby" data-lang="ruby"><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord</span><span class="p">:</span><span class="ss">:Base</span>
  <span class="n">attr_accessible</span> <span class="ss">:first</span><span class="p">,</span> <span class="ss">:second</span>

  <span class="n">delegate</span> <span class="ss">:content_tag</span><span class="p">,</span> <span class="ss">:safe_join</span><span class="p">,</span> <span class="ss">to</span><span class="p">:</span> <span class="s1">&#39;ApplicationController.helpers&#39;</span>
  <span class="k">def</span> <span class="nf">full_name</span>
    <span class="c1"># Конечно заносить элементы оформления в модель не очень хорошо,</span>
    <span class="c1"># я бы даже сказал совсем не хорошо. Но для этого нам и нужны</span>
    <span class="c1"># интуиция, опыт и лень, чтобы отличить добро от зла.</span>
    <span class="n">safe_join</span> <span class="o">[</span><span class="n">content_tag</span><span class="p">(</span><span class="ss">:b</span><span class="p">,</span> <span class="n">first</span><span class="p">),</span> <span class="n">second</span><span class="o">]</span><span class="p">,</span> <span class="s1">&#39; &amp;mdash; &#39;</span><span class="o">.</span><span class="n">html_safe</span> 
  <span class="k">end</span> 
<span class="k">end</span>
</code></pre></div><div class="highlight"><pre><code class="haml language-haml" data-lang="haml"><span class="nt">%p</span><span class="p">=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">full_name</span>  <span class="c1"># =&gt; &lt;p&gt;&lt;b&gt;Alexey&lt;/b&gt; &amp;mdash; Vakhov&lt;/p&gt;</span>
</code></pre></div>
<p>Вообще я поддерживаю разумные хаки. Бизнес-логику обязательно нужно хачить. Я всегда сначала во вьюхе буду создавать длинную
колбаску <code>@products.rejected(&amp;:disabled?).select{|p| p.price &gt; 1000}.reverse</code>. И только когда она станет совсем неприличной,
я вынесу ее с длинным, стремным именем в <code>ApplicationHelper</code> и начну мусорить там. Возможно это и нарушает академические
стандарты, но зато все скажут спасибо при поддержке. Так как, чтобы поправить вьюху, нужно будет заглянуть всего в один файл.</p>

<p>А если вы увидите что-нибудь типа <code>@products.render_me(self)</code>, в контроллере окажется, что <code>@products</code> это декоратор, в декораторе
<code>render_me</code> реализован через родительский класс и пачку миксинов. Вообщем после 4-го уровня абстракции кэш вашей
памяти переполнится окончательно. К тому же руби все равно не переплюнуть C++ в плане абстракции. Простой код должен
выглядеть просто, сложный - сложно.</p>

<h2>Обход двух и более массивов одного размера</h2>

<p>Глубинный эстетизм кода мне тоже не чужд, поэтому когда мне пришлось написать пару раз что-то похожее на:</p>
<div class="highlight"><pre><code class="ruby language-ruby" data-lang="ruby"><span class="n">array_a</span> <span class="o">=</span> <span class="o">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="o">]</span>
<span class="n">array_b</span> <span class="o">=</span> <span class="o">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="o">]</span>

<span class="k">if</span> <span class="n">array_a</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="n">array_b</span><span class="o">.</span><span class="n">size</span>
  <span class="n">array_a</span><span class="o">.</span><span class="n">each_with_index</span> <span class="k">do</span> <span class="o">|</span><span class="n">a</span><span class="p">,</span> <span class="n">ind</span><span class="o">|</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">array_b</span><span class="o">[</span><span class="n">ind</span><span class="o">]</span>
    <span class="c1"># do something with a &amp; b</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div>
<p>несимметричность данного решения меня раздражала. И в рейлс я случайно заметил кусочек, который почему-то не пришел в голову раньше:</p>
<div class="highlight"><pre><code class="ruby language-ruby" data-lang="ruby"><span class="k">if</span> <span class="n">array_a</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="n">array_b</span><span class="o">.</span><span class="n">size</span>
  <span class="n">array_a</span><span class="o">.</span><span class="n">size</span><span class="o">.</span><span class="n">times</span> <span class="k">do</span> <span class="o">|</span><span class="n">ind</span><span class="o">|</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">array_a</span><span class="o">[</span><span class="n">ind</span><span class="o">]</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">array_b</span><span class="o">[</span><span class="n">ind</span><span class="o">]</span>
    <span class="c1"># do something with a &amp; b</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div>
<p>Второй вариант мне нравится сильно больше. Не удивлюсь, если в руби есть еще более
симметричный способ обойти несколько массивов одновременно,
ведь API руби - безгранично.</p>

</div>

<div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'vakhov-me'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

        <div class="footer">
          <div class="contact">
            <img src="https://secure.gravatar.com/avatar/54e74983d81fa2fbe4c28e8392532f18" class="logo">
          </div>
          <div class="contact">
            <p>
              Alexey Vakhov<br>
              <a href=mailto:vakhov@gmail.com>vakhov@gmail.com</a>
            </p>
          </div>
          <div class="contact">
            <p>
              <img src="/images/twitter.ico"> - <a href="https://twitter.com/#!/avakhov">twitter</a><br>
              <img src="/images/github.ico"> - <a href="https://github.com/avakhov">github</a><br>
              <img src="/images/skype.ico"> - avakhov
            </p>
          </div>
          <div class="contact">
            <p>
              <img src="/images/instagram.ico"> - <a href="http://instagram.com/avakhov">instagram</a><br>
            </p>
          </div>
        </div>
      </div>
    </div> <!-- /container -->
  </body>
</html>
