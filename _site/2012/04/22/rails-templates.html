<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title>Автоматизация создания нового приложения с помощью рейлс-темплейтов</title>
    <meta name="viewport" content="width=device-width">
    <link href="/fonts/all.css" rel="stylesheet">
    <style>* { font-family: 'PT Sans' !important; }</style>
    <link rel="stylesheet" href="/css/bootstrap.css">
    <link rel="stylesheet" href="/css/syntax.css">
    <link rel="stylesheet" href="/css/blog.css">
  </head>
  <body>
    <div class="container">
      <div class="site">
        <div class="header">
  <h1 class="title"><a href="/">Blog</a></h1>
</div>
<h1>Автоматизация создания нового приложения с помощью рейлс-темплейтов</h1>
<p class="meta">22 Apr 2012</p>

<div class="post">
<p>Рейлс уже очень давно поддерживает темплейты при создании нового приложения. До недавнего времени я недооценивал мощь этого инструмента.
Сегодня я хочу расскать, как я использую темплейты сейчас и привести несколько хитростей из личной практики.</p>

<p>Если вы писали генераторы, то вы уже знакомы с темплейтами, так как они построены на том же коде, что и генераторы.
В любом случае вот этих 3 ссылок достаточно, чтобы узнать всю необходимую информацию:</p>

<ul>
<li><a href="http://m.onkey.org/rails-templates">http://m.onkey.org/rails-templates</a></li>
<li><a href="http://guides.rubyonrails.org/generators.html">http://guides.rubyonrails.org/generators.html</a></li>
<li><a href="http://rdoc.info/github/wycats/thor/master/Thor/Actions.html">http://rdoc.info/github/wycats/thor/master/Thor/Actions.html</a></li>
</ul>

<p>Иван Евтухович удачно заметил на конференции, что нужная степень автоматизации, это когда все автоматизировано до безобразия.
Я абсолютно согласен с данным утверждением и стараюсь автоматизировать именно до этой степени, а иногда даже чуточку больше.</p>

<p>Любая автоматизация, это маленькая локальная инновация. И кроме уменьшения сроков выполнения и увеличения качества
конкретной задачи у нее есть неочевидный, но очень важный эффект - <em>автоматизация влияет на повседневные шаблоны
поведения программиста и на конечный результат</em>. Поясню на примерах. Agile кроме уменьшения сроков и увеличения
отзывчивости девелопмента помогает создавать
легкие, изящные приложения, которые не получится разработать обычными методами. Гитхаб и рубиджемс помогли нам получить
огромное количество интересного кода, который раньше не был бы открытым, даже не из-за желания скрыть свои наработки, а
из-за сложности публикации и поддержки своего опен-сорса. Гит показал нам, как здорово создавать ветки и делать маленькие комиты.
Раньше нам казалось, что ветки не нужно создавать часто, но оказывается это было не потому-что сама идея веток - бесполезна, а
потому-что сложности создания и мержа уничтожали все потенциальные приемущества. Автоматизация (как и выбор правильных
инструментов) помогает взглянуть на старые подходы к работе под другим углом, выработать и использовать новые навыки, и, в конечном
итоге, получить принципиально другой результат.</p>

<p>Вернемся к теме сегодняшней беседы.
В повседневной практике довольно редко приходится создавать новое приложение, обычно это приходится делать
только в начале нового проекта. Но в любом случае у каждого программиста сформирован
набор гемов и начальных настроек, которые бы он хотел использовать в любом проекте независимо от размера и назначения.
У меня тоже есть такой набор, каждый раз я его применял вручную, поэтому гем-файлы всех проектов выглядят чуть-чуть
по разному. Но вообще я всегда создавал новый проект с неохотой, потому-что нужно было добавить поддержку хамл,
спеки, удалить index.html, настроить базу и сделать еще много всяких маленьких скучных правок. Кроме того я люблю возиться
с исходниками рейлс и часто у меня возникает вопрос, как работает та или иная функциональность.
Было бы удобно иметь всегда рабочий стенд, на котором можно быстро проверять свои гипотезы. Я пробовал использовать
для этого пустой sandbox-проект, но он очень быстро приходил в негодность, плюс иногда еще хочется посмотреть как это работало 
например в 3.0 или даже в 2.3. Можно конечно еще делать так: создать пустое приложение <code>rails new ...</code>, добавить therubyracer, bundle install, настроить базу, bundle install, фух - не хватает haml, bundle install, опс - хочу автомиграции, я к ним привык - добавить, bundle install - да ну в качель эту идею и рейлс целиком, пусть работают как хотят...</p>

<p>Сейчас я создаю пустое приложение несколько раз за день. Так как, чтобы проверить как работает тот или иной код в чистых рейлс достаточно 3-х простых команд:</p>
<div class="highlight"><pre><code class="text language-text" data-lang="text">rails new demo-app -m &lt;путь-до-темплейта&gt; # у меня есть заготовки для 3.0, 3.1 и 3.2
cd demo-app
rails s   # привычное и прекрасное окружение запущено

# hack, hack, hack

cd .. &amp;&amp; rm -fr demo-app
</code></pre></div>
<p>В заключение приведу свой основной темплейт-файл, который я обычно использую:</p>
<div class="highlight"><pre><code class="ruby language-ruby" data-lang="ruby"><span class="c1"># Можно использовать просто команду `file`, но в этом случае</span>
<span class="c1"># при попытке переписать существующий файл, система спросит:</span>
<span class="c1"># &quot;уверенны ли вы?&quot; Конечно уверены! Мы же создаем проект с</span>
<span class="c1"># нуля и не хотим лишний раз нажимать ентер.</span>
<span class="k">def</span> <span class="nf">file_force</span><span class="p">(</span><span class="nb">name</span><span class="p">,</span> <span class="n">content</span><span class="p">)</span>
  <span class="n">f</span> <span class="o">=</span> <span class="no">File</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="nb">name</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
  <span class="n">f</span><span class="o">.</span><span class="n">puts</span> <span class="n">content</span>
  <span class="n">f</span><span class="o">.</span><span class="n">close</span>
<span class="k">end</span>

<span class="n">file_force</span> <span class="s1">&#39;Gemfile&#39;</span><span class="p">,</span> <span class="o">&lt;&lt;-</span><span class="no">CODE</span>
<span class="sh">source &#39;https://rubygems.org&#39;</span>

<span class="sh">gem &#39;rails&#39;, &#39;3.2.3&#39;</span>
<span class="sh">gem &#39;pg&#39;</span>

<span class="sh">gem &#39;haml&#39;</span>
<span class="sh">gem &#39;jquery-rails&#39;</span>
<span class="sh">gem &#39;unicorn&#39;</span>

<span class="sh">group :assets do</span>
<span class="sh">  gem &#39;sass-rails&#39;,   &#39;~&gt; 3.2.3&#39;</span>
<span class="sh">  gem &#39;coffee-rails&#39;, &#39;~&gt; 3.2.1&#39;</span>
<span class="sh">  gem &#39;therubyracer&#39;, :platform =&gt; :ruby</span>
<span class="sh">  gem &#39;uglifier&#39;, &#39;&gt;= 1.0.3&#39;</span>
<span class="sh">end</span>

<span class="sh">group :development do</span>
<span class="sh">  gem &#39;rails-footnotes&#39;, git: &#39;git://github.com/avakhov/rails-footnotes.git&#39;, branch: &#39;custom&#39;</span>
<span class="sh">end</span>

<span class="sh">group :test do</span>
<span class="sh">  gem &#39;factory_girl_rails&#39;</span>
<span class="sh">  gem &#39;timecop&#39;</span>
<span class="sh">  gem &#39;database_cleaner&#39;</span>
<span class="sh">end</span>

<span class="sh">group :development, :test do</span>
<span class="sh">  gem &#39;rspec-rails&#39;</span>
<span class="sh">end</span>
<span class="no">CODE</span>

<span class="n">file_force</span> <span class="s1">&#39;.gitignore&#39;</span><span class="p">,</span> <span class="o">&lt;&lt;-</span><span class="no">CODE</span>
<span class="sh">/.bundle</span>
<span class="sh">/log/*.log</span>
<span class="sh">/tmp</span>
<span class="sh">/public/assets</span>
<span class="no">CODE</span>

<span class="n">file</span> <span class="s1">&#39;README.md&#39;</span><span class="p">,</span> <span class="o">&lt;&lt;-</span><span class="no">CODE</span>
<span class="sh"># Project</span>

<span class="sh">TODO: description</span>
<span class="no">CODE</span>

<span class="n">file</span> <span class="s1">&#39;.rspec&#39;</span><span class="p">,</span> <span class="o">&lt;&lt;-</span><span class="no">CODE</span>
<span class="sh">--colour</span>
<span class="no">CODE</span>

<span class="n">file</span> <span class="s1">&#39;spec/spec_helper.rb&#39;</span><span class="p">,</span> <span class="o">&lt;&lt;-</span><span class="no">CODE</span>
<span class="sh">ENV[&quot;RAILS_ENV&quot;] ||= &#39;test&#39;</span>
<span class="sh">require File.expand_path(&quot;../../config/environment&quot;, __FILE__)</span>
<span class="sh">require &#39;rspec/rails&#39;</span>
<span class="sh">require &#39;rspec/autorun&#39;</span>

<span class="sh">Dir[Rails.root.join(&quot;spec/support/**/*.rb&quot;)].each {|f| require f}</span>

<span class="sh">RSpec.configure do |config|</span>
<span class="sh">  config.before(:suite) do</span>
<span class="sh">    DatabaseCleaner.strategy = :transaction</span>
<span class="sh">  end</span>

<span class="sh">  config.before(:each) do</span>
<span class="sh">    DatabaseCleaner.start</span>
<span class="sh">  end</span>

<span class="sh">  config.after(:each) do</span>
<span class="sh">    DatabaseCleaner.clean</span>
<span class="sh">  end</span>

<span class="sh">  config.include FactoryGirl::Syntax::Methods</span>
<span class="sh">end</span>
<span class="no">CODE</span>

<span class="n">file</span> <span class="s1">&#39;spec/factories.rb&#39;</span><span class="p">,</span> <span class="o">&lt;&lt;-</span><span class="no">CODE</span>
<span class="sh">FactoryGirl.define do</span>
<span class="sh">  # factory :demo do</span>
<span class="sh">  #   name &#39;name&#39;</span>
<span class="sh">  # end</span>
<span class="sh">end</span>
<span class="no">CODE</span>

<span class="n">file</span> <span class="s1">&#39;app/controllers/home_controller.rb&#39;</span><span class="p">,</span> <span class="o">&lt;&lt;-</span><span class="no">CODE</span>
<span class="sh">class HomeController &lt; ApplicationController</span>
<span class="sh">  def index</span>
<span class="sh">  end</span>
<span class="sh">end</span>
<span class="no">CODE</span>

<span class="n">file</span> <span class="s1">&#39;app/views/home/index.html.haml&#39;</span><span class="p">,</span> <span class="o">&lt;&lt;-</span><span class="no">CODE</span>
<span class="sh">%h1 Home#index</span>
<span class="sh">%p Find me in app/views/home/index.html.haml</span>
<span class="no">CODE</span>

<span class="n">file</span> <span class="s1">&#39;spec/controllers/home_controller_spec.rb&#39;</span><span class="p">,</span> <span class="o">&lt;&lt;-</span><span class="no">CODE</span>
<span class="sh">require &#39;spec_helper&#39;</span>

<span class="sh">describe HomeController do</span>
<span class="sh">  it &quot;index&quot; do</span>
<span class="sh">    get &#39;index&#39;</span>
<span class="sh">    response.should be_success</span>
<span class="sh">  end</span>
<span class="sh">end</span>
<span class="no">CODE</span>

<span class="c1"># Нам не нужны примеры роутов, мы и так все знаем!</span>
<span class="n">head</span> <span class="o">=</span> <span class="no">File</span><span class="o">.</span><span class="n">readlines</span><span class="p">(</span><span class="s1">&#39;config/routes.rb&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">first</span>
<span class="n">file_force</span> <span class="s1">&#39;config/routes.rb&#39;</span><span class="p">,</span> <span class="o">&lt;&lt;-</span><span class="no">CODE</span>
<span class="sh">#{head.strip}</span>
<span class="sh">  root to: &#39;home#index&#39;</span>
<span class="sh">end</span>
<span class="no">CODE</span>

<span class="c1"># Скрипт темплейта запускается в директории</span>
<span class="c1"># созданного проекта:</span>
<span class="no">FileUtils</span><span class="o">.</span><span class="n">rm</span><span class="p">(</span><span class="s1">&#39;public/index.html&#39;</span><span class="p">)</span>
<span class="no">FileUtils</span><span class="o">.</span><span class="n">rm</span><span class="p">(</span><span class="s1">&#39;README.rdoc&#39;</span><span class="p">)</span>
<span class="no">FileUtils</span><span class="o">.</span><span class="n">rm_rf</span><span class="p">(</span><span class="s1">&#39;test&#39;</span><span class="p">)</span>

<span class="c1"># И мы можем запускать даже шелл-команды</span>
<span class="nb">system</span> <span class="s2">&quot;bundle install&quot;</span>
<span class="nb">system</span> <span class="s2">&quot;rake db:create db:migrate db:test:prepare&quot;</span>
<span class="nb">system</span> <span class="s2">&quot;git init&quot;</span>
<span class="nb">system</span> <span class="s2">&quot;git add .&quot;</span>
<span class="nb">system</span> <span class="s2">&quot;git ci -amInitial&quot;</span>
</code></pre></div>
<p>После выполения этого темплейта, создается приложение с базой, с главной страницей (можно подключить
devise, которому нужен <code>root_path</code>) и зелеными спеками.
Можно вызвать команду <code>rails g scaffold post title:string &amp;&amp; rake db:migrate</code> и экспериментировать
с моделями. Scaffold-генератор создает много файлов стоит сказать, если он нам не понравится
мы удалим его с помощью <code>git checkout . &amp;&amp; git clean -df</code>, а может создадим чистый проект заново, с темплейтами - это просто!</p>

</div>

<div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'vakhov-me'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

        <div class="footer">
          <div class="contact">
            <img src="https://secure.gravatar.com/avatar/54e74983d81fa2fbe4c28e8392532f18" class="logo">
          </div>
          <div class="contact">
            <p>
              Alexey Vakhov<br>
              <a href=mailto:vakhov@gmail.com>vakhov@gmail.com</a>
            </p>
          </div>
          <div class="contact">
            <p>
              <img src="/images/twitter.ico"> - <a href="https://twitter.com/#!/avakhov">twitter</a><br>
              <img src="/images/github.ico"> - <a href="https://github.com/avakhov">github</a><br>
              <img src="/images/skype.ico"> - avakhov
            </p>
          </div>
          <div class="contact">
            <p>
              <img src="/images/instagram.ico"> - <a href="http://instagram.com/avakhov">instagram</a><br>
            </p>
          </div>
        </div>
      </div>
    </div> <!-- /container -->
  </body>
</html>
