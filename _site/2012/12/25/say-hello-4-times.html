<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title>4 способа сказать миру привет</title>
    <meta name="viewport" content="width=device-width">
    <link href="/fonts/all.css" rel="stylesheet">
    <style>* { font-family: 'PT Sans' !important; }</style>
    <link rel="stylesheet" href="/css/bootstrap.css">
    <link rel="stylesheet" href="/css/syntax.css">
    <link rel="stylesheet" href="/css/blog.css">
  </head>
  <body>
    <div class="container">
      <div class="site">
        <div class="header">
  <h1 class="title"><a href="/">Blog</a></h1>
</div>
<h1>4 способа сказать миру привет</h1>
<p class="meta">25 Dec 2012</p>

<div class="post">
<p>Сегодня я расскажу как сделать несколько простых http-серверов на руби, каждый из которых можно использовать
для решения тех или иных задач.</p>

<h2>Hello Sinatra</h2>

<p>Самый высокоуровневый вариант. Sinatra-приложения идеально подходят для написания небольших API, простое приложение пишется
очень быстро:</p>
<div class="highlight"><pre><code class="ruby language-ruby" data-lang="ruby"><span class="nb">require</span> <span class="s1">&#39;rubygems&#39;</span>
<span class="nb">require</span> <span class="s1">&#39;sinatra&#39;</span>

<span class="n">set</span> <span class="ss">:port</span><span class="p">,</span> <span class="mi">8000</span>

<span class="n">get</span> <span class="s1">&#39;/&#39;</span> <span class="k">do</span>
  <span class="s1">&#39;Hello&#39;</span>
<span class="k">end</span>
</code></pre></div>
<h2>Hallo Rack</h2>

<p>Подавляющее большинство современных руби-фреймворков (в том числе синатра и рейлс) используют гем <code>rack</code>,
который реализует низкоуровневые http-интерфейсы.
Простой веб-сервер можно написать и на чистом rack:</p>
<div class="highlight"><pre><code class="ruby language-ruby" data-lang="ruby"><span class="nb">require</span> <span class="s1">&#39;rubygems&#39;</span>
<span class="nb">require</span> <span class="s1">&#39;rack&#39;</span>

<span class="ss">Rack</span><span class="p">:</span><span class="ss">:Server</span><span class="o">.</span><span class="n">start</span><span class="p">(</span>
  <span class="ss">app</span><span class="p">:</span> <span class="no">Proc</span><span class="o">.</span><span class="n">new</span><span class="p">{</span> <span class="o">|</span><span class="n">e</span><span class="o">|</span>
    <span class="o">[</span><span class="mi">200</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;Content-Type&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;text/html&#39;</span><span class="p">},</span> <span class="o">[</span><span class="s1">&#39;Hello&#39;</span><span class="o">]]</span>
  <span class="p">},</span>
  <span class="ss">Port</span><span class="p">:</span> <span class="mi">8000</span>
<span class="p">)</span>
</code></pre></div>
<h2>Salut Webrick</h2>

<p>Слово вебрик я знаю еще со времен рейлс 1, когда я первый раз узнал про фреймворк, но для меня стало открытием,
что вебрик оказывается включен в стандартные библиотеки руби. Вот он, родной:</p>
<div class="highlight"><pre><code class="ruby language-ruby" data-lang="ruby"><span class="nb">require</span> <span class="s1">&#39;webrick&#39;</span>

<span class="ss">WEBrick</span><span class="p">:</span><span class="ss">:HTTPServer</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">:Port</span> <span class="o">=&gt;</span> <span class="mi">8000</span><span class="p">)</span><span class="o">.</span><span class="n">tap</span> <span class="k">do</span> <span class="o">|</span><span class="n">server</span><span class="o">|</span>
  <span class="n">server</span><span class="o">.</span><span class="n">mount_proc</span> <span class="s1">&#39;/&#39;</span> <span class="k">do</span> <span class="o">|</span><span class="n">req</span><span class="p">,</span> <span class="n">res</span><span class="o">|</span>
    <span class="n">res</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="s1">&#39;Hello&#39;</span>
  <span class="k">end</span>
  <span class="nb">trap</span><span class="p">(</span><span class="s1">&#39;INT&#39;</span><span class="p">){</span> <span class="n">server</span><span class="o">.</span><span class="n">shutdown</span> <span class="p">}</span>
  <span class="n">server</span><span class="o">.</span><span class="n">start</span>
<span class="k">end</span>
</code></pre></div>
<p>Кстати, лог, который выдает данный скрипт, до боли знакомый:</p>
<div class="highlight"><pre><code class="text language-text" data-lang="text">~/proj/avakhov.github.com(1.9.3-p194)[source]$ ruby salut_webrick.rb 
[2012-12-26 10:21:52] INFO  WEBrick 1.3.1
[2012-12-26 10:21:52] INFO  ruby 1.9.3 (2012-04-20) [x86_64-darwin11.4.2]
[2012-12-26 10:21:52] INFO  WEBrick::HTTPServer#start: pid=28642 port=8000
localhost - - [26/Dec/2012:10:21:58 MSK] &quot;GET / HTTP/1.1&quot; 200 5
- -&gt; /
^C[2012-12-26 10:22:05] INFO  going to shutdown ...
[2012-12-26 10:22:05] INFO  WEBrick::HTTPServer#start done.
</code></pre></div>
<h2>Привет TCP сервер</h2>

<p>Как то раз я изучал проблему с сайтом, который на каждый 2-3 клик залипал на 30 секунд и отрывался по таймауту.
В чем была причина я уже не помню, однако в процессе исследований я познакомился с замечательной утилитой <code>tcpdump</code> (ничего
более похожего на Матрицу я еще пока не видел), а также запускал примитивные веб-серверы на руби. В процессе исследования кода
руби нашел еще более низкоуровневый веб сервер, чем вебрик, он уже по настоящему прекрасен:</p>
<div class="highlight"><pre><code class="ruby language-ruby" data-lang="ruby"><span class="nb">require</span> <span class="s1">&#39;socket&#39;</span>

<span class="no">TCPServer</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="mi">8000</span><span class="p">)</span><span class="o">.</span><span class="n">tap</span> <span class="k">do</span> <span class="o">|</span><span class="n">server</span><span class="o">|</span>
  <span class="kp">loop</span> <span class="k">do</span>
    <span class="n">client</span> <span class="o">=</span> <span class="n">server</span><span class="o">.</span><span class="n">accept</span>
    <span class="nb">puts</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">client</span><span class="o">.</span><span class="n">addr</span><span class="o">[</span><span class="mi">2</span><span class="o">]</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">while</span> <span class="n">line</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">gets</span> <span class="ow">and</span> <span class="n">line</span> <span class="o">!~</span> <span class="sr">/^\s*$/</span>
      <span class="nb">puts</span> <span class="n">line</span>
    <span class="k">end</span>
    <span class="nb">puts</span> <span class="s2">&quot;&quot;</span>

    <span class="n">resp</span> <span class="o">=</span> <span class="s2">&quot;Hello&quot;</span>

    <span class="n">headers</span> <span class="o">=</span> <span class="o">[</span>
      <span class="s2">&quot;http/1.1 200 ok&quot;</span><span class="p">,</span>
      <span class="s2">&quot;date: tue, 14 jan 1984 12:48:00 UTC+3&quot;</span><span class="p">,</span>
      <span class="s2">&quot;server: Ruby TCPServer&quot;</span><span class="p">,</span>
      <span class="s2">&quot;content-type: text/html; charset=utf-8&quot;</span><span class="p">,</span>
      <span class="s2">&quot;content-length: </span><span class="si">#{</span><span class="n">resp</span><span class="o">.</span><span class="n">length</span><span class="si">}</span><span class="se">\r\n\r\n</span><span class="s2">&quot;</span><span class="o">].</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\r\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="o">]</span>
    <span class="n">client</span><span class="o">.</span><span class="n">write</span> <span class="n">headers</span>
    <span class="n">client</span><span class="o">.</span><span class="n">write</span> <span class="n">resp</span>
    <span class="n">client</span><span class="o">.</span><span class="n">close</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div>
<p>Если вдруг станет скучно на работе, вы всегда можете написать какой-нибудь простой http-сервер на руби, возможно это
вас развеселит. Хороших праздников!</p>

</div>

<div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'vakhov-me'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

        <div class="footer">
          <div class="contact">
            <img src="https://secure.gravatar.com/avatar/54e74983d81fa2fbe4c28e8392532f18" class="logo">
          </div>
          <div class="contact">
            <p>
              Alexey Vakhov<br>
              <a href=mailto:vakhov@gmail.com>vakhov@gmail.com</a>
            </p>
          </div>
          <div class="contact">
            <p>
              <img src="/images/twitter.ico"> - <a href="https://twitter.com/#!/avakhov">twitter</a><br>
              <img src="/images/github.ico"> - <a href="https://github.com/avakhov">github</a><br>
              <img src="/images/skype.ico"> - avakhov
            </p>
          </div>
          <div class="contact">
            <p>
              <img src="/images/instagram.ico"> - <a href="http://instagram.com/avakhov">instagram</a><br>
            </p>
          </div>
        </div>
      </div>
    </div> <!-- /container -->
  </body>
</html>
