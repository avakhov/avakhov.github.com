<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title>Гемы - require и bundler</title>
    <meta name="viewport" content="width=device-width">
    <link href="/fonts/all.css" rel="stylesheet">
    <style>* { font-family: 'PT Sans' !important; }</style>
    <link rel="stylesheet" href="/css/bootstrap.css">
    <link rel="stylesheet" href="/css/syntax.css">
    <link rel="stylesheet" href="/css/blog.css">
  </head>
  <body>
    <div class="container">
      <div class="site">
        <div class="header">
  <h1 class="title"><a href="/">Blog</a></h1>
</div>
<h1>Гемы - require и bundler</h1>
<p class="meta">04 May 2012</p>

<div class="post">
<p>![]{/assets/7-gem/gem2.jpg}</p>

<p>Мне не хватит духу написать подробное руководство как создать гем, к тому же я сам не эксперт в этом вопросе, лучше
расскажу сегодня про еще одну ошибку, на которую я потратил пару часов, дойдя даже до отладки. Она
настолько глупая, что не хочется, чтобы еще кто-то терял свое время. Точнее говоря, это даже не ошибка, а заблуждение.</p>

<p>В одном гемспеке я прописал зависимость от хамла:</p>
<div class="highlight"><pre><code class="ruby language-ruby" data-lang="ruby"><span class="c1">### secret.gemspec</span>
<span class="ss">Gem</span><span class="p">:</span><span class="ss">:Specification</span><span class="o">.</span><span class="n">new</span> <span class="k">do</span> <span class="o">|</span><span class="n">gem</span><span class="o">|</span>
  <span class="n">gem</span><span class="o">.</span><span class="n">authors</span>       <span class="o">=</span> <span class="o">[</span><span class="s2">&quot;Alexey Vakhov&quot;</span><span class="o">]</span>
  <span class="c1"># ..</span>

  <span class="n">gem</span><span class="o">.</span><span class="n">add_dependency</span> <span class="s1">&#39;haml&#39;</span>
</code></pre></div>
<p>Этот гем является энджином, в нем есть контроллеры и вьюхи. Все прекрасно работало на тестовом приложении, но когда я прикрутил
его к новому проекту, то хамл-вьюхи перестали подцеплятся. Я заглядывал в Gemfile.lock файл и видел зависимость от хамла, но вьюхи
не работали, не находился обработчик хамл. Так как я был совершенно уверен, что эта схема правильная, то мне пришлось потратить
довольно много времени, чтобы разобраться.</p>

<p>Думаю, вы уже поняли в чем была проблема. Я уже настолько привык к магии бандлера в рейлс, что не задумывался,
как это работает. Однако, когда мы используем бандлер вне рейлс, то написав гем-файл и вставив <code>require &quot;bundler/setup&quot;</code>
мы просто ограничиваем область видимости для <code>require</code>:</p>
<div class="highlight"><pre><code class="ruby language-ruby" data-lang="ruby"><span class="nb">require</span> <span class="s2">&quot;rubygems&quot;</span>
<span class="nb">require</span> <span class="s2">&quot;bundler/setup&quot;</span>

<span class="no">Nokorigi</span> <span class="c1"># =&gt; uninitialized constant Nokogiri (NameError)</span>

<span class="c1"># require your gems as usual (Nokorigi прописан в гем-файле)</span>
<span class="nb">require</span> <span class="s2">&quot;nokogiri&quot;</span>

<span class="no">Nokorigi</span> <span class="c1"># =&gt; OK</span>

<span class="nb">require</span> <span class="s2">&quot;unicorn&quot;</span> <span class="c1"># =&gt; cannot load such file -- unicorn (LoadError)</span>
</code></pre></div>
<p>Это пример взят с <a href="http://gembundler.com/">официального сайта бандлера</a>. Рейлс идет дальше и автоматически включает
все гемы из гем-файла (ориентируясь на енвайромент) в проект с помощью <code>Bundler.require</code>:</p>
<div class="highlight"><pre><code class="ruby language-ruby" data-lang="ruby"><span class="c1"># config/application.rb чистого проекта</span>

<span class="k">if</span> <span class="n">defined?</span><span class="p">(</span><span class="no">Bundler</span><span class="p">)</span>
  <span class="no">Bundler</span><span class="o">.</span><span class="n">require</span><span class="p">(</span><span class="o">*</span><span class="no">Rails</span><span class="o">.</span><span class="n">groups</span><span class="p">(</span><span class="ss">:assets</span> <span class="o">=&gt;</span> <span class="sx">%w(development test)</span><span class="p">))</span>
<span class="k">end</span>
</code></pre></div>
<p>Таким образом в моем проекте бандлер включил по умолчанию мой гем, но не включил хамл, так как он не был прописан в гем-файле проекта, 
а была только зависимость!
Гемспек используется при установке и в данном случае игнорируется бандлером. В тестовом приложении, на котором я разрабатывал гем,
хамл был включен в гем-файл и поэтому ошибки не было. Чтобы бы больше не попадаться в эту ловушку, во всех гемах я явно включаю
все зависимости в главном файле:</p>
<div class="highlight"><pre><code class="ruby language-ruby" data-lang="ruby"><span class="c1">### secret.gemspec</span>
<span class="ss">Gem</span><span class="p">:</span><span class="ss">:Specification</span><span class="o">.</span><span class="n">new</span> <span class="k">do</span> <span class="o">|</span><span class="n">gem</span><span class="o">|</span>
  <span class="n">gem</span><span class="o">.</span><span class="n">authors</span>       <span class="o">=</span> <span class="o">[</span><span class="s2">&quot;Alexey Vakhov&quot;</span><span class="o">]</span>
  <span class="c1"># ..</span>

  <span class="n">gem</span><span class="o">.</span><span class="n">add_dependency</span> <span class="s1">&#39;haml&#39;</span>
  <span class="n">gem</span><span class="o">.</span><span class="n">add_dependency</span> <span class="s1">&#39;modularity&#39;</span>
  <span class="n">gem</span><span class="o">.</span><span class="n">add_dependency</span> <span class="s1">&#39;nokorigi&#39;</span>
<span class="k">end</span>

<span class="c1">### lib/secret.rb</span>
<span class="nb">require</span> <span class="s1">&#39;haml&#39;</span>
<span class="nb">require</span> <span class="s1">&#39;modularity&#39;</span>
<span class="nb">require</span> <span class="s1">&#39;nokorigi&#39;</span>
<span class="nb">require</span> <span class="s1">&#39;secret/version&#39;</span>
<span class="c1"># ...</span>
</code></pre></div>
<p>Практика показывает, что сначала нужно искать ошибки в своем коде, потом в фреймворке, потом в компиляторе, потом в железе, потом ... хм, в мироздании наверное :) Из сложных ситуаций, я ловил один раз крэш руби на домашнем компьютере из-за немного битой памяти. Руби - прожорливый язык и когда залезал в сбойные ячейки, то падал. Я догадался запустить мемтест, хотя никогда с таким не сталкивался. К слову сказать и сама система вела себя немного станно. </p>

<p>Второй случай, может быть вы поможете в нем разобраться. Я все собираюсь запустить что-нибудь в
продакшн на JRuby с мультитредовым рейлс. В MRI пугают GIL (у-у-у-у, страшно. Не знаю что это, но похоже какая-то пакость, которая
не позволяет параллелить программу на несколько ядер) и плохими тредами. Поэтому готовлюсь заранее.</p>

<p>Насколько я понимаю, чтобы
ничего не шлепнулось, необходимо избегать использовать члены класса. Я обернул код из статьи <a href="http://coderrr.wordpress.com/2008/04/10/lets-stop-polluting-the-threadcurrent-hash/">Let’s stop polluting the Thread.current hash</a> в
гем <a href="https://github.com/avakhov/thread_local_accessor">thread<em>local</em>accessor</a>, но он (хвала travis-ci) падал на руби 1.9.3-p125
(на p0 работал хорошо) на конструкции <code>ObjectSpace.define_finalizer Thread.current, FINALIZER</code>. Видимо в p125 нельзя прилеплять
финалайзер к <code>Thread.current</code> (я нахожусь на чертовско тонком льду понятий, которые очень слабо понимаю,
поэтому могу сморозить что-нибудь не то).</p>

<p>Я переписал код таким образом, что вроде он должен быть потоко-безопасным и
работает на всех версиях руби. Сейчас проверяю эту библиотеку на живых проектах, пока в однопоточном режиме:</p>
<div class="highlight"><pre><code class="ruby language-ruby" data-lang="ruby"><span class="c1"># https://github.com/avakhov/thread_local_accessor/blob/master/lib/thread_local_accessor.rb</span>

<span class="k">class</span> <span class="nc">Class</span>
  <span class="k">def</span> <span class="nf">thread_local_accessor</span> <span class="nb">name</span><span class="p">,</span> <span class="n">options</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">m</span> <span class="o">=</span> <span class="no">Module</span><span class="o">.</span><span class="n">new</span>
    <span class="n">m</span><span class="o">.</span><span class="n">module_eval</span> <span class="sx">%{</span>
<span class="sx">      def </span><span class="si">#{</span><span class="nb">name</span><span class="si">}</span><span class="sx"></span>
<span class="sx">        k = ((Class === self ? self : self.class).object_id.to_s + &#39;_</span><span class="si">#{</span><span class="nb">name</span><span class="si">}</span><span class="sx">&#39;).to_sym</span>
<span class="sx">        if Thread.current.key?(k)</span>
<span class="sx">          Thread.current[k]</span>
<span class="sx">        else</span>
<span class="sx">          </span><span class="si">#{</span><span class="n">options</span><span class="o">[</span><span class="ss">:default</span><span class="o">].</span><span class="n">inspect</span><span class="si">}</span><span class="sx"></span>
<span class="sx">        end</span>
<span class="sx">      end</span>

<span class="sx">      def </span><span class="si">#{</span><span class="nb">name</span><span class="si">}</span><span class="sx">=(val)</span>
<span class="sx">        k = ((Class === self ? self : self.class).object_id.to_s + &#39;_</span><span class="si">#{</span><span class="nb">name</span><span class="si">}</span><span class="sx">&#39;).to_sym</span>
<span class="sx">        Thread.current[k] = val</span>
<span class="sx">      end</span>
<span class="sx">    }</span>

    <span class="nb">class_eval</span> <span class="k">do</span>
      <span class="kp">include</span> <span class="n">m</span>
      <span class="kp">extend</span> <span class="n">m</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div>
<p>Вы знаете почему падал предыдущий код и, как вы думаете, новый подход нормальный?</p>

</div>

<div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'vakhov-me'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

        <div class="footer">
          <div class="contact">
            <img src="https://secure.gravatar.com/avatar/54e74983d81fa2fbe4c28e8392532f18" class="logo">
          </div>
          <div class="contact">
            <p>
              Alexey Vakhov<br>
              <a href=mailto:vakhov@gmail.com>vakhov@gmail.com</a>
            </p>
          </div>
          <div class="contact">
            <p>
              <img src="/images/twitter.ico"> - <a href="https://twitter.com/#!/avakhov">twitter</a><br>
              <img src="/images/github.ico"> - <a href="https://github.com/avakhov">github</a><br>
              <img src="/images/skype.ico"> - avakhov
            </p>
          </div>
          <div class="contact">
            <p>
              <img src="/images/instagram.ico"> - <a href="http://instagram.com/avakhov">instagram</a><br>
            </p>
          </div>
        </div>
      </div>
    </div> <!-- /container -->
  </body>
</html>
