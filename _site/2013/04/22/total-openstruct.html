<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title>Эксперименты с OpenStruct и JSON-схемами</title>
    <meta name="viewport" content="width=device-width">
    <link href="/fonts/all.css" rel="stylesheet">
    <style>* { font-family: 'PT Sans' !important; }</style>
    <link rel="stylesheet" href="/css/bootstrap.css">
    <link rel="stylesheet" href="/css/syntax.css">
    <link rel="stylesheet" href="/css/blog.css">
  </head>
  <body>
    <div class="container">
      <div class="site">
        <div class="header">
  <h1 class="title"><a href="/">Blog</a></h1>
</div>
<h1>Эксперименты с OpenStruct и JSON-схемами</h1>
<p class="meta">22 Apr 2013</p>

<div class="post">
<p>Недавно мы решили выделить логические компоненты внутри нашего большого рейлс-приложения, чтобы в будущем возможно разделить приложение физически. Для стандартизации общения между частями системы я использовал JSON-совместимые объекты с валидацией при помощи JSON-схем и немного доработанный OpenStruct. Про этот эксперимент я и хочу рассказать в сегодняшней статье.</p>

<h2>Заменить хэши на OpenStruct</h2>

<p>Мне нравятся <code>OpenStruct</code> структуры, пример использования которых можно посмотреть в <a href="http://ruby-doc.org/stdlib-1.9.3/libdoc/ostruct/rdoc/OpenStruct.html">официальной документации</a>:</p>
<div class="highlight"><pre><code class="ruby language-ruby" data-lang="ruby"><span class="nb">require</span> <span class="s1">&#39;ostruct&#39;</span>

<span class="n">person</span> <span class="o">=</span> <span class="no">OpenStruct</span><span class="o">.</span><span class="n">new</span>
<span class="n">person</span><span class="o">.</span><span class="n">name</span>    <span class="o">=</span> <span class="s2">&quot;John Smith&quot;</span>
<span class="n">person</span><span class="o">.</span><span class="n">age</span>     <span class="o">=</span> <span class="mi">70</span>
<span class="n">person</span><span class="o">.</span><span class="n">pension</span> <span class="o">=</span> <span class="mi">300</span>

<span class="nb">puts</span> <span class="n">person</span><span class="o">.</span><span class="n">name</span>     <span class="c1"># -&gt; &quot;John Smith&quot;</span>
<span class="nb">puts</span> <span class="n">person</span><span class="o">.</span><span class="n">age</span>      <span class="c1"># -&gt; 70</span>
<span class="nb">puts</span> <span class="n">person</span><span class="o">.</span><span class="n">address</span>  <span class="c1"># -&gt; nil</span>
</code></pre></div>
<p>Мне кажется гораздо приятнее написать в коде <code>person.address.street</code>, чем <code>person[:address][:street]</code> однако по привычке обычно используют вторую запись. В рамках эксперимента я изменил несколько методов в <code>OpenStruct</code>:</p>

<p>``` ruby config/initializer/monkey<em>patching.rb
class OpenStruct
  def as</em>json
    marshal<em>dump.as</em>json
  end</p>

<p>def to<em>json
    marshal</em>dump.to_json
  end</p>

<p>def to<em>s
    marshal</em>dump.to_s
  end</p>

<p>def inspect
    to_s
  end
end
```</p>

<p>сделав тем самым <code>OpenStruct</code> полностью совместимыми с обычными хэшами в рамках наших задач:</p>
<div class="highlight"><pre><code class="ruby language-ruby" data-lang="ruby"><span class="c1"># До изменения (в JSON появляется лишняя вложенность элементов структуры,</span>
<span class="c1"># инспект-запись объекта более громоздкая чем в обычном хэше)</span>
<span class="no">OpenStruct</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">a</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="ss">b</span><span class="p">:</span> <span class="o">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="o">]</span><span class="p">)</span><span class="o">.</span><span class="n">to_json</span>   <span class="c1"># =&gt; &quot;{\&quot;table\&quot;:{\&quot;a\&quot;:3,\&quot;b\&quot;:[1,2]}}&quot;</span>
<span class="no">OpenStruct</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">a</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="ss">b</span><span class="p">:</span> <span class="o">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="o">]</span><span class="p">)</span><span class="o">.</span><span class="n">as_json</span>   <span class="c1"># =&gt; {&quot;table&quot;=&gt;{:a=&gt;3, :b=&gt;[1, 2]}}</span>
<span class="no">OpenStruct</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">a</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="ss">b</span><span class="p">:</span> <span class="o">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="o">]</span><span class="p">)</span><span class="o">.</span><span class="n">inspect</span>   <span class="c1"># =&gt; &quot;#&lt;OpenStruct a=3, b=[1, 2]&gt;&quot;</span>

<span class="c1"># После изменения</span>
<span class="no">OpenStruct</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">a</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="ss">b</span><span class="p">:</span> <span class="o">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="o">]</span><span class="p">)</span><span class="o">.</span><span class="n">to_json</span>   <span class="c1"># =&gt; &quot;{\&quot;a\&quot;:3,\&quot;b\&quot;:[1,2]}&quot;</span>
<span class="no">OpenStruct</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">a</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="ss">b</span><span class="p">:</span> <span class="o">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="o">]</span><span class="p">)</span><span class="o">.</span><span class="n">as_json</span>   <span class="c1"># =&gt; {&quot;a&quot;=&gt;3, &quot;b&quot;=&gt;[1, 2]}</span>
<span class="no">OpenStruct</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">a</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="ss">b</span><span class="p">:</span> <span class="o">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="o">]</span><span class="p">)</span><span class="o">.</span><span class="n">inspect</span>   <span class="c1"># =&gt; &quot;{:a=&gt;3, :b=&gt;[1, 2]}&quot;</span>

<span class="c1"># Стандартный хэш</span>
<span class="p">{</span><span class="ss">a</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="ss">b</span><span class="p">:</span> <span class="o">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="o">]</span><span class="p">}</span><span class="o">.</span><span class="n">to_json</span>      <span class="c1"># =&gt; &quot;{\&quot;a\&quot;:3,\&quot;b\&quot;:[1,2]}&quot;</span>
<span class="p">{</span><span class="ss">a</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="ss">b</span><span class="p">:</span> <span class="o">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="o">]</span><span class="p">}</span><span class="o">.</span><span class="n">as_json</span>      <span class="c1"># =&gt; {&quot;a&quot;=&gt;3, &quot;b&quot;=&gt;[1, 2]}</span>
<span class="p">{</span><span class="ss">a</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="ss">b</span><span class="p">:</span> <span class="o">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="o">]</span><span class="p">}</span><span class="o">.</span><span class="n">inspect</span>      <span class="c1"># =&gt; &quot;{:a=&gt;3, :b=&gt;[1, 2]}&quot;</span>
</code></pre></div>
<h2>JSON Schema</h2>

<p>Веселый гибкий JSON пришел на смену жуткому XML с DTD таблицами. Однако после глотка свободы обязательно следует затянуть гайки. Поэтому люди придумали <a href="http://json-schema.org/">JSON Schema</a>, который сейчас проходит <a href="http://tools.ietf.org/html/draft-zyp-json-schema-03">третье чтение</a> в органиции IETF. JSON Schema позволяет валидировать корректность JSON-объекта, проверять типы полей и простые граничные условия. В нашем проекте я использовал гем <a href="https://github.com/hoxworth/json-schema">json-schema</a>, который может валидировать руби-объекты по такой же схеме как и Javascript-объекты. </p>

<p>Для работы системы с первым логическим компонентов я создал интерфейсный модуль с стаческими методами, используя шаблон проектирования <a href="http://c2.com/cgi/wiki?PimplIdiom">PIMPL</a>.</p>

<p>Рассмотрим организации валидации значения на примере интерфейсного метода <code>get_users</code>,
который возвращает массив пользователей, используя указатель на реализацию интерфейса <code>impl</code>.
Возвращаемое значение проходит проверку на соответствие его JSON-схеме, заданной в модуле.</p>

<p>Обратите внимание на ключ <code>additionalProperties</code>, который я всегда выставляю для объектов в <code>false</code>,
чтобы запретить использование свойств, не описанных в схеме.
Также посмотрите на ограничения, наложенные на свойство <code>age</code>.
Возраст является не обязательным, но если он все-таки указан, то он должен
быть числом не меньше 5 и не больше 120.</p>

<p>Если возвращаемое значение не совпадает с заявленной схемой, то <code>JSON::Validator.validate!</code> вызовет эксепшн.</p>
<div class="highlight"><pre><code class="ruby language-ruby" data-lang="ruby"><span class="k">module</span> <span class="nn">LogicComponent</span>
  <span class="n">mattr_accessor</span> <span class="ss">:impl</span>

  <span class="no">USERS_SCHEMA</span> <span class="o">=</span> <span class="p">{</span>
    <span class="ss">type</span><span class="p">:</span> <span class="s2">&quot;array&quot;</span><span class="p">,</span>
    <span class="ss">items</span><span class="p">:</span> <span class="p">{</span>
      <span class="ss">type</span><span class="p">:</span> <span class="s2">&quot;object&quot;</span><span class="p">,</span>
      <span class="ss">additionalProperties</span><span class="p">:</span> <span class="kp">false</span><span class="p">,</span>
      <span class="ss">properties</span><span class="p">:</span> <span class="p">{</span>
        <span class="ss">lname</span><span class="p">:</span> <span class="p">{</span> <span class="ss">type</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span><span class="p">,</span> <span class="ss">required</span><span class="p">:</span> <span class="kp">true</span> <span class="p">},</span>
        <span class="ss">fname</span><span class="p">:</span> <span class="p">{</span> <span class="ss">type</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span><span class="p">,</span> <span class="ss">required</span><span class="p">:</span> <span class="kp">true</span> <span class="p">},</span>
        <span class="ss">age</span><span class="p">:</span> <span class="p">{</span> <span class="ss">type</span><span class="p">:</span> <span class="s2">&quot;integer&quot;</span><span class="p">,</span> <span class="ss">required</span><span class="p">:</span> <span class="kp">false</span><span class="p">,</span> <span class="ss">minimum</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span> <span class="ss">maximum</span><span class="p">:</span> <span class="mi">120</span> <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="k">class</span> <span class="o">&lt;&lt;</span> <span class="nb">self</span>
    <span class="c1"># LogicComponent.init вызывается в инициализаторе рейлс-приложения</span>
    <span class="k">def</span> <span class="nf">init</span>
      <span class="nb">self</span><span class="o">.</span><span class="n">impl</span> <span class="o">=</span> <span class="ss">LogicComponent</span><span class="p">:</span><span class="ss">:Impl</span><span class="o">.</span><span class="n">new</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">get_users</span><span class="p">(</span><span class="n">country</span><span class="p">)</span>
      <span class="n">impl</span><span class="o">.</span><span class="n">get_users</span><span class="p">(</span><span class="n">country</span><span class="p">)</span><span class="o">.</span><span class="n">tap</span> <span class="k">do</span> <span class="o">|</span><span class="n">out</span><span class="o">|</span>
        <span class="ss">JSON</span><span class="p">:</span><span class="ss">:Validator</span><span class="o">.</span><span class="n">validate!</span><span class="p">(</span><span class="no">USERS_SCHEMA</span><span class="o">.</span><span class="n">as_json</span><span class="p">,</span> <span class="n">out</span><span class="o">.</span><span class="n">as_json</span><span class="p">)</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div>
<p>Простая реализация impl-части (удобно вынести функционал в отдельный класс, чтобы было легче
тестировать и, например, использовать кеширование <code>@member ||= ...</code>):</p>
<div class="highlight"><pre><code class="ruby language-ruby" data-lang="ruby"><span class="k">module</span> <span class="nn">LogicComponent</span>
  <span class="k">class</span> <span class="nc">Impl</span>
    <span class="k">def</span> <span class="nf">get_users</span><span class="p">(</span><span class="n">country</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">country</span> <span class="o">==</span> <span class="s1">&#39;Russia&#39;</span>
        <span class="o">[</span>
          <span class="no">OpenStruct</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">fname</span><span class="p">:</span> <span class="s1">&#39;Alexey&#39;</span><span class="p">,</span> <span class="ss">lname</span><span class="p">:</span> <span class="s1">&#39;Vakhov&#39;</span><span class="p">,</span> <span class="ss">age</span><span class="p">:</span> <span class="mi">29</span><span class="p">)</span>
        <span class="o">]</span>
      <span class="k">else</span>
        <span class="o">[]</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div>
<p>И наконец практическое применение, для работы с результатом используем магию <code>OpenStruct</code>:</p>
<div class="highlight"><pre><code class="ruby language-ruby" data-lang="ruby"><span class="no">LogicComponent</span><span class="o">.</span><span class="n">init</span>
<span class="no">LogicComponent</span><span class="o">.</span><span class="n">get_users</span><span class="p">(</span><span class="s2">&quot;Russia&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="o">.</span><span class="n">tap</span> <span class="k">do</span> <span class="o">|</span><span class="n">user</span><span class="o">|</span>
  <span class="nb">puts</span> <span class="n">user</span><span class="o">.</span><span class="n">fname</span>   <span class="c1"># =&gt; &quot;Alexey&quot;</span>
  <span class="nb">puts</span> <span class="n">user</span><span class="o">.</span><span class="n">lname</span>   <span class="c1"># =&gt; &quot;Vakhov&quot;</span>
  <span class="nb">puts</span> <span class="n">user</span><span class="o">.</span><span class="n">age</span>     <span class="c1"># =&gt; 29</span>
<span class="k">end</span>
</code></pre></div>
<p>Подобным образом можно реализовать все необходимые методы модуля <code>LogicComponent</code>.</p>

<h2>Итоги</h2>

<p>Во многих случаях структуры <code>OpenStruct</code> являются полноценной и более удобной заменой внутренних хешей.</p>

<p>Использовать стандартизированных JSON-схем в руби для проверки входных параметров и результатов во
внутреннем API мне очень понравилось. Эта идея перекликается с методологией программирования
по контракту, которая мне также симпатична. Не знаю как обстоят дела с производительностью гема
<code>json-schema</code>, однако идеологически решение получается очень приятным.</p>

</div>

<div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'vakhov-me'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

        <div class="footer">
          <div class="contact">
            <img src="https://secure.gravatar.com/avatar/54e74983d81fa2fbe4c28e8392532f18" class="logo">
          </div>
          <div class="contact">
            <p>
              Alexey Vakhov<br>
              <a href=mailto:vakhov@gmail.com>vakhov@gmail.com</a>
            </p>
          </div>
          <div class="contact">
            <p>
              <img src="/images/twitter.ico"> - <a href="https://twitter.com/#!/avakhov">twitter</a><br>
              <img src="/images/github.ico"> - <a href="https://github.com/avakhov">github</a><br>
              <img src="/images/skype.ico"> - avakhov
            </p>
          </div>
          <div class="contact">
            <p>
              <img src="/images/instagram.ico"> - <a href="http://instagram.com/avakhov">instagram</a><br>
            </p>
          </div>
        </div>
      </div>
    </div> <!-- /container -->
  </body>
</html>
